<div class="flex flex-col gap-6 min-h-full w-full">
  <!-- Statistics cards section -->
  <div class="flex flex-row gap-y-4 gap-xl-2 justify-between flex-wrap">
    <!-- Pending quotes counter card -->
    <div class="w-full sm:w-[48%] lg:xl:w-[24%] 2xl:w-1/5 shrink-0">
      <app-dashboard-info-card
        [cardTitle]="'Pending Quotes'"
        [cardDescription]="getPendingCount().toString()"
        [cardIconClass]="'pi pi-clock'"
      />
    </div>
    <!-- Accepted quotes counter card -->
    <div class="w-full sm:w-[48%] lg:xl:w-[24%] 2xl:w-1/5 shrink-0">
      <app-dashboard-info-card
        [cardTitle]="'Accepted'"
        [cardDescription]="getAcceptedCount().toString()"
        [cardIconClass]="'pi pi-check-circle'"
      />
    </div>
    <!-- Rejected quotes counter card -->
    <div class="w-full sm:w-[48%] lg:xl:w-[24%] 2xl:w-1/5 shrink-0">
      <app-dashboard-info-card
        [cardTitle]="'Rejected'"
        [cardDescription]="getRejectedCount().toString()"
        [cardIconClass]="'pi pi-times-circle'"
      />
    </div>
    <!-- Total quotes counter card -->
    <div class="w-full sm:w-[48%] lg:xl:w-[24%] 2xl:w-1/5 shrink-0">
      <app-dashboard-info-card
        [cardTitle]="'Total Quotes'"
        [cardDescription]="totalRecords.toString()"
        [cardIconClass]="'pi pi-list'"
      />
      <div class="w-full sm:w-1/2 lg:w-1/3 xl:w-1/4"></div>
    </div>
  </div>

  <div class="flex flex-col pb-2 pt-6 border-0 bg-card rounded-xl shadow flex-grow min-h-100">
    <!-- Table header and description -->
    <div class="px-6 flex flex-col gap-1">
      <span class="font-bold text-2xl"> Quote Responses </span>
      <span class="text-sm text-secondary">
        Overview of quotes received from sellers and their current status
      </span>
    </div>
    <div>
      <app-data-table
        [cols]="cols"
        [rows]="10"
        [totalRecords]="totalRecords"
        [dataLoading]="loading"
        [data]="quotesData"
        [multiSortMeta]="multiSortMeta"
        [bodyTemplate]="customBodyTemplate"
        (loadDataEvent)="loadQuotesData($event)"
      >
      </app-data-table>
    </div>
  </div>

  <ng-template #customBodyTemplate let-rowData let-rowIndex="rowIndex">
    <tr [class]="rowData.status === 'pending' ? 'surface-50' : ''">
      <td class="text-center w-[5%] shrink-1">{{ rowData.id }}</td>
      <td class="text-center w-[20%] text-nowrap">
        @if (rowData.seller?.full_name) {
          {{ rowData.seller?.full_name }}
        } @else if (rowData.seller?.first_name && rowData.seller?.last_name) {
          {{ rowData.seller?.first_name }} {{ rowData.seller?.last_name }}
        } @else {
          <span class="text-surface-400 italic">Unknown Seller</span>
        }
      </td>
      <td class="text-center w-[15%] text-nowrap">
        <div class="quote-items-summary">
          @if (rowData.quote_items && rowData.quote_items.length > 0) {
            <span
              >{{ rowData.quote_items.length }}
              {{ rowData.quote_items.length === 1 ? 'item' : 'items' }}</span
            >
          } @else if (rowData.items && rowData.items.length > 0) {
            <span
              >{{ rowData.items.length }} {{ rowData.items.length === 1 ? 'item' : 'items' }}</span
            >
          } @else {
            <span>No items</span>
          }
        </div>
      </td>
      <td class="text-center w-[15%] text-nowrap">
        <strong>{{
          rowData.total_price || rowData.total_amount | currency: 'USD' : 'symbol' : '1.2-2'
        }}</strong>
      </td>
      <td class="text-center w-[10%]">
        <p-badge
          [value]="rowData.status | titlecase"
          [severity]="getStatusSeverity(rowData.status)"
          [style]="{
            'background-color': getStatusColor(rowData.status),
            color: getStatusTextColor(rowData.status),
          }"
        ></p-badge>
      </td>
      <td class="text-center w-[15%] text-nowrap">{{ rowData.created_at | date: 'short' }}</td>
      <td class="flex justify-center shrink-1">
        <div class="action-buttons">
          <p-button
            [icon]="'pi pi-eye'"
            [rounded]="true"
            [raised]="true"
            size="small"
            [title]="'View Details'"
            (onClick)="viewQuoteDetails(rowData)"
          />

          <p-button
            icon="pi pi-check"
            [rounded]="true"
            [outlined]="true"
            [raised]="true"
            severity="success"
            size="small"
            [title]="'Accept Quote'"
            [disabled]="
              rowData.status === 'rejected' ||
              rowData.status === 'cancelled' ||
              rowData.status === 'accepted'
            "
            (onClick)="acceptQuote(rowData)"
          />

          <p-button
            icon="pi pi-times"
            [rounded]="true"
            [outlined]="true"
            [raised]="true"
            severity="danger"
            size="small"
            [title]="'Reject Quote'"
            [disabled]="
              rowData.status === 'rejected' ||
              rowData.status === 'cancelled' ||
              rowData.status === 'accepted'
            "
            (onClick)="rejectQuote(rowData)"
          />

          <p-button
            icon="pi pi-comments"
            [rounded]="true"
            [raised]="true"
            size="small"
            [title]="'Chat with Seller'"
            (onClick)="openChat(rowData)"
          />
        </div>
      </td>
    </tr>
  </ng-template>

  <p-toast></p-toast>

  <p-dialog
    header="Quote Details"
    [(visible)]="quoteDetailsVisible"
    [modal]="true"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '80vw', maxWidth: '800px' }"
    styleClass="quote-details-modal"
  >
    @if (selectedQuote) {
      <div class="quote-details-content p-4">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="quote-info-section">
            <h3 class="text-lg font-semibold mb-4 text-primary flex items-center">
              <i class="pi pi-file-text mr-2"></i>
              Quote Information
            </h3>
            <div class="space-y-3">
              <div class="flex items-center gap-3">
                <span class="text-sm font-medium text-secondary min-w-[120px]">Quote ID:</span>
                <span class="text-sm font-bold">#{{ selectedQuote.id }}</span>
              </div>
              @if (selectedQuote.rfq_id) {
                <div class="flex items-center gap-3">
                  <span class="text-sm font-medium text-secondary min-w-[120px]">RFQ ID:</span>
                  <span class="text-sm font-bold">#{{ selectedQuote.rfq_id }}</span>
                </div>
              }
              <div class="flex items-center gap-3">
                <span class="text-sm font-medium text-secondary min-w-[120px]">Status:</span>
                <p-badge
                  [value]="selectedQuote.status | titlecase"
                  [severity]="getStatusSeverity(selectedQuote.status)"
                  [style]="{
                    'background-color': getStatusColor(selectedQuote.status),
                    color: getStatusTextColor(selectedQuote.status),
                  }"
                ></p-badge>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-sm font-medium text-secondary min-w-[120px]">Date Received:</span>
                <span class="text-sm">{{ selectedQuote.created_at | date: 'medium' }}</span>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-sm font-medium text-secondary min-w-[120px]">Total Amount:</span>
                <span class="text-sm font-bold text-primary">
                  {{
                    selectedQuote.total_price || selectedQuote.total_amount
                      | currency: 'USD' : 'symbol' : '1.2-2'
                  }}
                </span>
              </div>
            </div>
          </div>

          <!-- Seller information panel -->
          <div class="seller-info-section">
            <h3 class="text-lg font-semibold mb-4 text-primary flex items-center">
              <i class="pi pi-user mr-2"></i>
              Seller Information
            </h3>
            <div class="space-y-3">
              <div class="flex items-center gap-3">
                <span class="text-sm font-medium text-secondary min-w-[100px]">Name:</span>
                <span class="text-sm font-bold">
                  @if (selectedQuote.seller.full_name) {
                    {{ selectedQuote.seller.full_name }}
                  } @else if (selectedQuote.seller.first_name && selectedQuote.seller.last_name) {
                    {{ selectedQuote.seller.first_name }} {{ selectedQuote.seller.last_name }}
                  } @else {
                    <span class="text-surface-400 italic">Unknown Seller</span>
                  }
                </span>
              </div>
              @if (selectedQuote.seller.email) {
                <div class="flex items-center gap-3">
                  <span class="text-sm font-medium text-secondary min-w-[100px]">Email:</span>
                  <span class="text-sm text-primary">{{ selectedQuote.seller.email }}</span>
                </div>
              }
              @if (selectedQuote.seller.phone_number) {
                <div class="flex items-center gap-3">
                  <span class="text-sm font-medium text-secondary min-w-[100px]">Phone:</span>
                  <span class="text-sm">{{ selectedQuote.seller.phone_number }}</span>
                </div>
              }
              @if (selectedQuote.seller.company.name) {
                <div class="flex items-center gap-3">
                  <span class="text-sm font-medium text-secondary min-w-[100px]">Company:</span>
                  <span class="text-sm font-bold">{{ selectedQuote.seller.company.name }}</span>
                </div>
              }
            </div>
          </div>
        </div>

        <!-- RFQ (Request for Quote) information section - shown if available -->
        @if (selectedQuote.rfq && hasRFQInformation(selectedQuote.rfq)) {
          <div class="rfq-info-section mb-6">
            <h3 class="text-lg font-semibold mb-4 text-primary flex items-center">
              <i class="pi pi-info-circle mr-2"></i>
              Request for Quote Information
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="space-y-3">
                @if (selectedQuote.rfq.initial_quantity) {
                  <div class="flex items-center gap-3">
                    <span class="text-sm font-medium text-secondary min-w-[120px]"
                      >Initial Quantity:</span
                    >
                    <span class="text-sm font-bold">{{
                      selectedQuote.rfq.initial_quantity | number
                    }}</span>
                  </div>
                }
                @if (selectedQuote.rfq.shipping_country) {
                  <div class="flex items-center gap-3">
                    <span class="text-sm font-medium text-secondary min-w-[120px]"
                      >Shipping Country:</span
                    >
                    <span class="text-sm font-bold">{{ selectedQuote.rfq.shipping_country }}</span>
                  </div>
                }
              </div>
              <div class="space-y-3">
                @if (selectedQuote.rfq.status) {
                  <div class="flex items-center gap-3">
                    <span class="text-sm font-medium text-secondary min-w-[100px]"
                      >RFQ Status:</span
                    >
                    <p-badge
                      [value]="selectedQuote.rfq.status | titlecase"
                      [severity]="getStatusSeverity(selectedQuote.rfq.status)"
                      [style]="{
                        'background-color': getStatusColor(selectedQuote.rfq.status),
                        color: getStatusTextColor(selectedQuote.rfq.status),
                      }"
                    ></p-badge>
                  </div>
                }
              </div>
            </div>
            <!-- Display original buyer message if available -->
            @if (selectedQuote.rfq.buyer_message) {
              <div class="mt-4">
                <h4 class="text-sm font-medium text-secondary mb-2">My Original Message:</h4>
                <div class="bg-surface-50 p-3 rounded-lg text-left border-l-4 border-primary">
                  <p class="text-sm leading-relaxed whitespace-pre-wrap">
                    {{ selectedQuote.rfq.buyer_message }}
                  </p>
                </div>
              </div>
            }
          </div>
        }

        <!-- Quote items section with detailed table -->
        <div class="quote-items-section mb-6">
          <h3 class="text-lg font-semibold mb-4 text-primary flex items-center">
            <i class="pi pi-list mr-2"></i>
            Quote Items
          </h3>
          <div class="overflow-x-auto">
            <p-table
              [value]="selectedQuote.quote_items || selectedQuote.items || []"
              [tableStyle]="{ 'min-width': '100%' }"
              styleClass="p-datatable-sm"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th class="text-left">Item Name</th>
                  <th class="text-left">Brand</th>
                  <th class="text-left">Description</th>
                  <th class="text-center">Quantity</th>
                  <th class="text-right">Unit Price</th>
                  <th class="text-right">Total</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-item>
                <tr>
                  <td class="font-medium">
                    {{ item.product_name || item.product?.name || 'N/A' }}
                  </td>
                  <td>{{ item.product_brand || item.product?.brand || '-' }}</td>
                  <td class="max-w-[200px] truncate">
                    {{ item.notes || item.product?.description || 'No description' }}
                  </td>
                  <td class="text-center">{{ item.quantity || 0 | number }}</td>
                  <td class="text-right">
                    {{ item.unit_price || 0 | currency: 'USD' : 'symbol' : '1.2-2' }}
                  </td>
                  <td class="text-right font-medium">
                    {{
                      item.total_price || item.subtotal || item.unit_price * item.quantity || 0
                        | currency: 'USD' : 'symbol' : '1.2-2'
                    }}
                  </td>
                </tr>
              </ng-template>
              <ng-template pTemplate="footer">
                <tr class="bg-surface-50">
                  <td colspan="5" class="text-left font-bold text-lg">Total Amount:</td>
                  <td class="text-right font-bold text-lg text-primary">
                    {{
                      selectedQuote.total_price || selectedQuote.total_amount
                        | currency: 'USD' : 'symbol' : '1.2-2'
                    }}
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </div>

        <!-- Additional seller message section -->
        <div class="additional-info-section">
          <h3 class="text-lg font-semibold mb-4 text-primary flex items-center">
            <i class="pi pi-comment mr-2"></i>
            Seller Message
          </h3>
          <div class="bg-surface-50 p-3 rounded-lg border-l-4 border-primary">
            <p class="text-sm leading-relaxed whitespace-pre-wrap">
              {{ selectedQuote.seller_message || 'No additional message from seller.' }}
            </p>
          </div>
        </div>
      </div>
    }

    <!-- Modal footer -->
    <ng-template pTemplate="footer">
      <div class="flex justify-end gap-3">
        <p-button
          label="Close"
          severity="secondary"
          outlined="true"
          (onClick)="quoteDetailsVisible = false"
        />
        @if (selectedQuote) {
          <div class="flex gap-2">
            <p-button
              icon="pi pi-check"
              severity="success"
              [rounded]="true"
              [title]="'Accept Quote'"
              [disabled]="
                selectedQuote.status === 'rejected' ||
                selectedQuote.status === 'cancelled' ||
                selectedQuote.status === 'accepted'
              "
              (onClick)="acceptQuote(selectedQuote!); quoteDetailsVisible = false"
            />
            <p-button
              icon="pi pi-times"
              severity="danger"
              outlined="true"
              [rounded]="true"
              [title]="'Reject Quote'"
              [disabled]="
                selectedQuote.status === 'rejected' ||
                selectedQuote.status === 'cancelled' ||
                selectedQuote.status === 'accepted'
              "
              (onClick)="rejectQuote(selectedQuote!); quoteDetailsVisible = false"
            />
            <p-button
              icon="pi pi-comments"
              [rounded]="true"
              [raised]="true"
              [title]="'Chat with Seller'"
              (onClick)="openChat(selectedQuote!); quoteDetailsVisible = false"
            />
          </div>
        }
      </div>
    </ng-template>
  </p-dialog>
</div>
