<nav
  class="fixed top-0 left-0 right-0 z-50 transition-all duration-300"
  [ngClass]="{
    'bg-slate-900/80 backdrop-blur-md shadow-sm': themeService.isDark(),
    'bg-white/90 backdrop-blur-md shadow-sm': !themeService.isDark(),
  }"
>
  <div class="container mx-auto px-4 py-4 flex items-center justify-between">
    <div class="flex items-center">
      <a
        routerLink="/"
        class="text-2xl font-bold transition-colors"
        [ngClass]="{
          'text-white hover:text-primary-300': themeService.isDark(),
          'text-slate-900 hover:text-primary-600': !themeService.isDark(),
        }"
      >
        Genie
      </a>
    </div>

    <div class="hidden md:flex items-center justify-center">
      <ul class="flex space-x-1">
        @for (item of items; track item.label) {
          <li>
            <a
              [routerLink]="item.routerLink"
              routerLinkActive="after:w-full"
              [routerLinkActiveOptions]="{ exact: item.routerLink === '/' }"
              class="relative px-4 py-2 transition-colors duration-300 overflow-hidden group"
              [ngClass]="{
                'text-white hover:text-primary-300': themeService.isDark(),
                'text-slate-900 hover:text-primary-600': !themeService.isDark(),
              }"
              [class.text-primary-300]="item.routerLink !== '/' && themeService.isDark()"
              [class.text-primary-600]="item.routerLink !== '/' && !themeService.isDark()"
            >
              {{ item.label }}
              <span
                class="absolute bottom-0 left-0 w-0 h-0.5 transition-all duration-300 group-hover:w-full"
                [ngClass]="{
                  'bg-primary-300': themeService.isDark(),
                  'bg-primary-600': !themeService.isDark(),
                }"
              ></span>
            </a>
          </li>
        }
      </ul>
    </div>

    <div class="hidden md:flex items-center space-x-4">
      @if (isAuthenticated()) {
        <p-button
          (click)="userPopover.toggle($event)"
          [text]="true"
          severity="secondary"
          styleClass="!p-1 !border-0 !bg-transparent hover:!bg-white/10 !transition-all !duration-300 hover:!scale-105 !rounded-xl"
        >
          <div class="flex items-center gap-3 px-2 py-1">
            <p-avatar
              [label]="user()?.first_name?.[0]?.toUpperCase()"
              class="!bg-primary-500 !text-white"
              size="normal"
              shape="circle"
            ></p-avatar>
            <div class="text-left hidden xl:block">
              <p
                class="text-sm font-semibold"
                [ngClass]="{
                  'text-white': themeService.isDark(),
                  'text-slate-900': !themeService.isDark(),
                }"
              >
                {{ user()?.first_name }}
              </p>
              <p
                class="text-xs"
                [ngClass]="{
                  'text-white/70': themeService.isDark(),
                  'text-slate-600': !themeService.isDark(),
                }"
              >
                {{ user()?.email }}
              </p>
            </div>
            <i
              class="pi pi-chevron-down text-xs"
              [ngClass]="{
                'text-white/70': themeService.isDark(),
                'text-slate-600': !themeService.isDark(),
              }"
            ></i>
          </div>
        </p-button>

        <p-popover
          #userPopover
          styleClass="!p-0 !border-2 !shadow-2xl !rounded-xl !overflow-hidden"
          [dismissable]="true"
          [focusOnShow]="true"
        >
          <!-- User Info Header -->
          <div
            class="p-6 bg-surface-0 dark:bg-surface-900 border-b border-surface-200 dark:border-surface-700"
          >
            <div class="flex items-center gap-4">
              <p-avatar
                [label]="user()?.first_name?.[0]?.toUpperCase()"
                class="!bg-primary-500 !text-white"
                size="large"
                shape="circle"
              ></p-avatar>
              <div class="flex-1">
                <p class="text-surface-900 dark:text-surface-0 font-semibold text-base mb-1">
                  {{ user()?.first_name }} {{ user()?.last_name }}
                </p>
                <p class="text-surface-600 dark:text-surface-400 text-sm">{{ user()?.email }}</p>
              </div>
            </div>
          </div>

          <!-- Menu Items -->
          <div class="p-2 min-w-72 bg-surface-0 dark:bg-surface-900">
            @for (item of userMenuItems(); track item) {
              @if (item.separator) {
                <p-divider class="my-2 mx-2"></p-divider>
              } @else if (item.visible !== false) {
                <a
                  [routerLink]="item.routerLink"
                  (click)="item.command ? item.command({}) : userPopover.hide()"
                  class="flex items-center gap-3 w-full p-3 mx-2 rounded-md text-surface-700 dark:text-surface-200 hover:bg-surface-100 dark:hover:bg-surface-800 hover:text-primary-600 dark:hover:text-primary-400 transition-all duration-200 cursor-pointer"
                >
                  <i [class]="item.icon" class="text-surface-500 dark:text-surface-400"></i>
                  <span class="font-medium">{{ item.label }}</span>
                </a>
              }
            }
          </div>
        </p-popover>
      } @else {
        <div class="flex items-center gap-3">
          <a routerLink="/auth/login">
            <p-button
              label="Sign In"
              [outlined]="true"
              severity="secondary"
              [styleClass]="
                themeService.isDark()
                  ? '!text-white !border-white/30 hover:!bg-white hover:!text-surface-900 !transition-all !duration-300 !font-medium lg:px-6! !py-2 hover:!scale-105'
                  : '!text-slate-900 !border-slate-300 hover:!bg-slate-100 hover:!text-slate-900 !transition-all !duration-300 !font-medium lg:px-6! !py-2 hover:!scale-105'
              "
            ></p-button>
          </a>
          <a routerLink="/auth/register">
            <p-button
              label="Sign Up"
              styleClass="!bg-primary-600 hover:!bg-primary-700 !border-primary-600 hover:!border-primary-700 !text-white !transition-all !duration-300 !font-medium lg:px-6! !py-2 hover:!scale-105"
            ></p-button>
          </a>
        </div>
      }

      <!-- Enhanced Theme Toggle -->
      <p-button
        (click)="toggleTheme()"
        [text]="true"
        severity="secondary"
        size="small"
        styleClass="'!p-2 !border-0 !bg-transparent hover:!bg-white/10 !transition-all !duration-300 hover:!scale-110 !rounded-full !w-10 !h-10"
        [attr.aria-label]="'Switch to ' + (themeService.isDark() ? 'light' : 'dark') + ' theme'"
      >
        <i
          [class]="themeService.isDark() ? 'pi pi-sun' : 'pi pi-moon'"
          class="text-xl"
          [ngClass]="{
            'text-white': themeService.isDark(),
            'text-slate-900': !themeService.isDark(),
          }"
        ></i>
      </p-button>
    </div>

    <!-- Mobile Hamburger Button -->
    <div class="md:hidden flex items-center gap-2">
      @if (isAuthenticated()) {
        <p-avatar
          [label]="user()?.first_name?.[0]?.toUpperCase()"
          class="!bg-primary-500 !text-white"
          size="normal"
          shape="circle"
        ></p-avatar>
      }
      <p-button
        (click)="drawerVisible.set(true)"
        [text]="true"
        severity="secondary"
        size="small"
        styleClass="!p-2 !border-0 !bg-transparent hover:!bg-white/10 !transition-all !duration-300 hover:!scale-110"
        aria-label="Open menu"
      >
        <i
          class="pi pi-bars text-xl"
          [ngClass]="{
            'text-white': themeService.isDark(),
            'text-slate-900': !themeService.isDark(),
          }"
        ></i>
      </p-button>
    </div>
  </div>
</nav>

<!-- Enhanced Mobile Drawer -->
<p-drawer
  [visible]="drawerVisible()"
  (visibleChange)="drawerVisible.set($event)"
  position="right"
  [modal]="true"
  [closeOnEscape]="true"
  styleClass="!w-80"
>
  <ng-template pTemplate="header">
    <div class="flex items-center justify-between w-full">
      <h2 class="text-xl font-semibold text-surface-900 dark:text-surface-0">Menu</h2>
    </div>
  </ng-template>

  <ng-template pTemplate="content">
    <div class="flex flex-col h-full space-y-6">
      <!-- Mobile User Section -->
      @if (isAuthenticated()) {
        <div
          class="p-4 bg-surface-50 dark:bg-surface-800 rounded-lg border border-surface-200 dark:border-surface-700"
        >
          <div class="flex items-center gap-3">
            <p-avatar
              [label]="user()?.first_name?.[0]?.toUpperCase()"
              class="!bg-primary-500 !text-white"
              size="large"
              shape="circle"
            ></p-avatar>
            <div class="flex-1">
              <p class="font-semibold text-surface-900 dark:text-surface-0">
                {{ user()?.first_name }} {{ user()?.last_name }}
              </p>
              <p class="text-sm text-surface-600 dark:text-surface-400">{{ user()?.email }}</p>
            </div>
          </div>
        </div>
      }

      <!-- Mobile Navigation -->
      <div>
        <h3
          class="text-xs font-semibold text-surface-500 dark:text-surface-400 uppercase tracking-wider mb-3"
        >
          Navigation
        </h3>
        <ul class="space-y-1">
          @for (item of items; track item.label) {
            <li>
              <a
                [routerLink]="item.routerLink"
                routerLinkActive="!bg-primary-50 dark:!bg-primary-900/20 !text-primary-600 dark:!text-primary-400 !border-r-2 !border-primary-500"
                [routerLinkActiveOptions]="{ exact: item.routerLink === '/' }"
                (click)="drawerVisible.set(false)"
                class="flex items-center justify-between p-3 rounded-md text-surface-700 dark:text-surface-200 hover:bg-surface-100 dark:hover:bg-surface-800 hover:text-primary-600 dark:hover:text-primary-400 transition-all duration-200 group"
              >
                <span class="font-medium">{{ item.label }}</span>
                <i
                  class="pi pi-chevron-right text-xs text-surface-400 group-hover:text-primary-500 transition-colors duration-200"
                ></i>
              </a>
            </li>
          }
        </ul>
      </div>

      <!-- Mobile User Menu -->
      @if (isAuthenticated()) {
        <div>
          <h3
            class="text-xs font-semibold text-surface-500 dark:text-surface-400 uppercase tracking-wider mb-3"
          >
            Account
          </h3>
          <ul class="space-y-1">
            @for (item of userMenuItems(); track item) {
              @if (!item.separator && item.visible !== false) {
                <li>
                  <a
                    [routerLink]="item.routerLink"
                    (click)="handleMobileMenuItemClick(item)"
                    class="flex items-center justify-between p-3 rounded-md text-surface-700 dark:text-surface-200 hover:bg-surface-100 dark:hover:bg-surface-800 hover:text-primary-600 dark:hover:text-primary-400 transition-all duration-200 group"
                  >
                    <div class="flex items-center gap-3">
                      <i [class]="item.icon" class="text-surface-500 dark:text-surface-400"></i>
                      <span class="font-medium">{{ item.label }}</span>
                    </div>
                    <i
                      class="pi pi-chevron-right text-xs text-surface-400 group-hover:text-primary-500 transition-colors duration-200"
                    ></i>
                  </a>
                </li>
              }
            }
          </ul>
        </div>
      } @else {
        <div>
          <h3
            class="text-xs font-semibold text-surface-500 dark:text-surface-400 uppercase tracking-wider mb-3"
          >
            Account
          </h3>
          <div class="flex flex-col gap-y-2">
            <a routerLink="/auth/login" (click)="drawerVisible.set(false)">
              <p-button
                label="Sign In"
                [outlined]="true"
                severity="secondary"
                styleClass="w-full !border-surface-300 dark:!border-surface-600 !text-surface-700 dark:!text-surface-200 hover:!bg-surface-100 dark:hover:!bg-surface-800 hover:!border-primary-500 hover:!text-primary-600 dark:hover:!text-primary-400 !transition-all !duration-200 !font-medium !py-3"
              ></p-button>
            </a>
            <a routerLink="/auth/register" (click)="drawerVisible.set(false)">
              <p-button
                label="Sign Up"
                styleClass="w-full !bg-primary-600 hover:!bg-primary-700 !border-primary-600 hover:!border-primary-700 !text-white !transition-all !duration-200 !font-medium !py-3"
              ></p-button>
            </a>
          </div>
        </div>
      }

      <!-- Mobile Theme Toggle -->
      <div class="mt-auto pt-6 border-t border-surface-200 dark:border-surface-700">
        <button
          (click)="toggleTheme()"
          class="w-full flex items-center justify-between p-3 rounded-md text-surface-700 dark:text-surface-200 hover:bg-surface-100 dark:hover:bg-surface-800 hover:text-primary-600 dark:hover:text-primary-400 transition-all duration-200"
          [attr.aria-label]="'Switch to ' + (themeService.isDark() ? 'light' : 'dark') + ' theme'"
        >
          <div class="flex items-center gap-3">
            <i
              [class]="themeService.isDark() ? 'pi pi-sun' : 'pi pi-moon'"
              class="text-lg text-surface-500 dark:text-surface-400"
            ></i>
            <span class="font-medium">{{ themeService.isDark() ? 'Light' : 'Dark' }} Mode</span>
          </div>
          <div
            class="relative w-11 h-6 rounded-full transition-all duration-300"
            [ngClass]="{
              'bg-primary-500': themeService.isDark(),
              'bg-surface-300': !themeService.isDark(),
            }"
          >
            <div
              class="absolute top-0.5 w-5 h-5 bg-white rounded-full shadow-sm transform transition-transform duration-300"
              [ngClass]="{
                'translate-x-5': themeService.isDark(),
                'translate-x-0.5': !themeService.isDark(),
              }"
            ></div>
          </div>
        </button>
      </div>
    </div>
  </ng-template>
</p-drawer>
